
'use server';
/**
 * @fileOverview An AI-powered code vulnerability scanner.
 *
 * - scanCodeForVulnerabilities - A function that analyzes code for vulnerabilities.
 * - ScanCodeInput - The input type for the scanCodeForVulnerabilities function.
 * - ScanCodeOutput - The return type for the scanCodeForVulnerabilities function.
 */

import {ai} from '@/ai/genkit';
import {z} from 'zod';

export const ScanCodeInputSchema = z.object({
  code: z.string().describe('The code snippet to analyze.'),
});
export type ScanCodeInput = z.infer<typeof ScanCodeInputSchema>;

export const ScanCodeOutputSchema = z.object({
  vulnerabilities: z.array(z.object({
    line: z.number().describe('The line number of the vulnerability.'),
    vulnerability: z.string().describe('A brief description of the vulnerability (e.g., "Cross-Site Scripting (XSS)").'),
    suggestion: z.string().describe('A suggestion on how to fix the vulnerability.'),
  })).describe('A list of vulnerabilities found in the code.'),
});
export type ScanCodeOutput = z.infer<typeof ScanCodeOutputSchema>;


export async function scanCodeForVulnerabilities(input: ScanCodeInput): Promise<ScanCodeOutput> {
  return codeVulnerabilityScannerFlow(input);
}

const prompt = ai.definePrompt({
  name: 'codeVulnerabilityScannerPrompt',
  input: {schema: ScanCodeInputSchema},
  output: {schema: ScanCodeOutputSchema},
  prompt: `You are an expert security code analyst. Analyze the following code snippet for common security vulnerabilities such as Cross-Site Scripting (XSS), SQL Injection, Insecure Direct Object References, etc.

For each vulnerability found, provide the line number, a brief description of the vulnerability, and a suggestion for how to fix it. If no vulnerabilities are found, return an empty array.

Code:
\'\'\'
{{{code}}}
\'\'\'`,
});


const codeVulnerabilityScannerFlow = ai.defineFlow(
  {
    name: 'codeVulnerabilityScannerFlow',
    inputSchema: ScanCodeInputSchema,
    outputSchema: ScanCodeOutputSchema,
  },
  async (input) => {
    const { output } = await prompt(input);
    return output!;
  }
);
