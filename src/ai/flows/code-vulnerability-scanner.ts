'use server';
/**
 * @fileOverview An AI-powered code vulnerability scanner.
 *
 * - scanCodeForVulnerabilities - A function that analyzes code for vulnerabilities.
 */

import {ai} from '@/ai/genkit';
import { ScanCodeInputSchema, ScanCodeOutputSchema, type ScanCodeInput } from './code-vulnerability-scanner-types';

export async function scanCodeForVulnerabilities(input: ScanCodeInput): Promise<import("./code-vulnerability-scanner-types").ScanCodeOutput> {
  return codeVulnerabilityScannerFlow(input);
}

const prompt = ai.definePrompt({
  name: 'codeVulnerabilityScannerPrompt',
  input: {schema: ScanCodeInputSchema},
  output: {schema: ScanCodeOutputSchema},
  prompt: `You are an expert security code analyst. Analyze the following code snippet for common security vulnerabilities such as Cross-Site Scripting (XSS), SQL Injection, Insecure Direct Object References, etc.

For each vulnerability found, provide the line number, a brief description of the vulnerability, and a suggestion for how to fix it. If no vulnerabilities are found, return an empty array.

Code:
\'\'\'
{{{code}}}
\'\'\'`,
});


const codeVulnerabilityScannerFlow = ai.defineFlow(
  {
    name: 'codeVulnerabilityScannerFlow',
    inputSchema: ScanCodeInputSchema,
    outputSchema: ScanCodeOutputSchema,
  },
  async (input) => {
    const { output } = await prompt(input);
    return output!;
  }
);
